name: Tag with latest AWS CLI version 🕵️‍♀️

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 5 * * *'

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: Get latest AWS CLI version
        id: latest_version
        uses: tdemin/find-latest-tag@v1.0.1
        with:
          repository: aws/aws-cli
          pattern: '2\.[0-9]+\.[0-9]+'

      - name: Check if tag exists already
        id: check_tag
        run: |
          if git rev-parse ${{ steps.latest_version.outputs.tag }} >/dev/null 2>&1
          then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Tag repo with latest AWS CLI version
        if: steps.check_tag.outputs.tag_exists == 'false'
        env:
          VERSION: ${{ steps.latest_version.outputs.tag }}
        run: |
          git config --local user.email "cicd@spacelift.io"
          git config --local user.name "Spacelift CI/CD"
          git tag -a $VERSION -m "AWS CLI version $VERSION"
          git push origin $VERSION